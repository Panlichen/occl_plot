import plot_bar
import os
import matplotlib.pyplot as plt
import numpy as np
from pprint import pprint
# from brokenaxes import brokenaxes
import matplotlib
matplotlib.rcParams['pdf.fonttype'] = 42
matplotlib.rcParams['ps.fonttype'] = 42
max_byte = 0
min_byte = 10000000000
legends = ["NCCL Bandwidth", "OCCL Bandwidth", "NCCL Latency", "OCCL Latency"]
x_labels = ["512", "1K", "2K", "4K", "8K", "16K", "32K", "64K", "128K", "256K",
            "512K", "1M", "2M", "4M", "8M", "16M", "32M", "64M", "128M", "256M", "512M", "1G"]

# dataset = ["2080ti-server, 4 GPUs", "3090-server, 8 GPUs", "3080ti-server 8 GPUs"]
dataset = ["2hosts", "4hosts"]
func = ["AR", "AG", "RS", "B", "R"]

data_dict = {
    "2hosts": {
        "AR": {
            "NCCL Bandwidth": {
                "512": [0.0, 0.0, 0.0],
                "1K": [0.01, 0.01, 0.01],
                "2K": [0.01, 0.01, 0.01],
                "4K": [0.02, 0.02, 0.02],
                "8K": [0.05, 0.05, 0.05],
                "16K": [0.1, 0.1, 0.1],
                "32K": [0.15, 0.16, 0.16],
                "64K": [0.29, 0.29, 0.3],
                "128K": [0.54, 0.54, 0.55],
                "256K": [1.02, 1.02, 1.06],
                "512K": [1.54, 1.55, 1.55],
                "1M": [1.73, 1.74, 1.75],
                "2M": [2.1, 2.1, 2.1],
                "4M": [2.13, 2.13, 2.13],
                "8M": [2.14, 2.14, 2.14],
                "16M": [2.14, 2.14, 2.14],
                "32M": [2.14, 2.14, 2.14]
            },
            "OCCL Bandwidth": {
                "512": [0.0, 0.0, 0.0],
                "1K": [0.01, 0.01, 0.01],
                "2K": [0.01, 0.01, 0.01],
                "4K": [0.03, 0.02, 0.02],
                "8K": [0.05, 0.05, 0.05],
                "16K": [0.1, 0.1, 0.1],
                "32K": [0.17, 0.17, 0.17],
                "64K": [0.33, 0.33, 0.3],
                "128K": [0.6, 0.59, 0.57],
                "256K": [1.06, 1.04, 1.04],
                "512K": [1.51, 1.51, 1.5],
                "1M": [1.77, 1.76, 1.76],
                "2M": [2.07, 2.05, 2.05],
                "4M": [2.12, 2.12, 2.12],
                "8M": [2.14, 2.14, 2.14],
                "16M": [2.15, 2.14, 2.14],
                "32M": [2.14, 2.14, 2.14]
            },
            "NCCL Latency": {
                "512": [151.0, 147.1, 146.4],
                "1K": [153.7, 152.1, 149.5],
                "2K": [156.3, 152.3, 151.5],
                "4K": [166.3, 166.2, 165.5],
                "8K": [164.1, 164.0, 163.4],
                "16K": [170.2, 166.6, 164.4],
                "32K": [212.1, 209.7, 208.4],
                "64K": [225.8, 222.5, 219.7],
                "128K": [243.8, 241.2, 236.7],
                "256K": [258.0, 255.9, 248.5],
                "512K": [340.5, 339.2, 339.1],
                "1M": [607.0, 603.1, 600.5],
                "2M": [998.6, 998.5, 998.2],
                "4M": [1973.5, 1973.3, 1973.0],
                "8M": [3925.0, 3922.3, 3919.9],
                "16M": [7826.3, 7824.4, 7824.3],
                "32M": [15657.0, 15656.0, 15655.0]
            },
            "OCCL Latency": {
                "512": [150.0, 151.2, 151.8],
                "1K": [150.4, 154.2, 161.0],
                "2K": [155.9, 156.3, 158.8],
                "4K": [161.2, 164.4, 169.9],
                "8K": [164.5, 165.1, 165.2],
                "16K": [168.4, 168.6, 169.2],
                "32K": [192.2, 193.6, 194.7],
                "64K": [197.8, 201.2, 215.5],
                "128K": [219.8, 222.7, 228.3],
                "256K": [247.6, 252.2, 252.2],
                "512K": [346.9, 347.3, 348.7],
                "1M": [592.2, 595.8, 596.9],
                "2M": [1013.2, 1020.6, 1021.9],
                "4M": [1975.3, 1978.9, 1980.3],
                "8M": [3921.8, 3926.2, 3927.6],
                "16M": [7821.2, 7824.9, 7836.1],
                "32M": [15647.0, 15649.0, 15655.0]
            }
        },
        "AG": {
            "NCCL Bandwidth": {
                "512": [0.0, 0.01, 0.01],
                "1K": [0.01, 0.01, 0.01],
                "2K": [0.02, 0.02, 0.02],
                "4K": [0.04, 0.04, 0.04],
                "8K": [0.08, 0.08, 0.08],
                "16K": [0.15, 0.15, 0.15],
                "32K": [0.27, 0.28, 0.28],
                "64K": [0.52, 0.54, 0.57],
                "128K": [1.05, 1.08, 1.1],
                "256K": [1.89, 1.89, 1.9],
                "512K": [2.84, 2.92, 2.93],
                "1M": [3.45, 3.47, 3.48],
                "2M": [4.08, 4.1, 4.1],
                "4M": [4.2, 4.2, 4.2],
                "8M": [4.24, 4.24, 4.24],
                "16M": [4.25, 4.25, 4.25],
                "32M": [4.25, 4.25, 4.25]
            },
            "OCCL Bandwidth": {
                "512": [0.0, 0.0, 0.0],
                "1K": [0.01, 0.01, 0.01],
                "2K": [0.02, 0.02, 0.02],
                "4K": [0.04, 0.04, 0.04],
                "8K": [0.08, 0.08, 0.08],
                "16K": [0.16, 0.16, 0.15],
                "32K": [0.3, 0.28, 0.28],
                "64K": [0.56, 0.55, 0.53],
                "128K": [1.12, 1.1, 1.08],
                "256K": [1.99, 1.97, 1.97],
                "512K": [2.96, 2.93, 2.92],
                "1M": [3.53, 3.53, 3.47],
                "2M": [4.01, 4.0, 3.99],
                "4M": [4.19, 4.19, 4.18],
                "8M": [4.24, 4.24, 4.23],
                "16M": [4.25, 4.25, 4.25],
                "32M": [4.26, 4.26, 4.26]
            },
            "NCCL Latency": {
                "512": [105.2, 101.8, 98.21],
                "1K": [101.3, 100.4, 97.99],
                "2K": [107.8, 104.3, 102.3],
                "4K": [101.4, 101.3, 100.7],
                "8K": [103.0, 99.95, 99.11],
                "16K": [109.0, 107.7, 107.5],
                "32K": [119.7, 118.1, 117.5],
                "64K": [126.5, 120.9, 115.8],
                "128K": [125.0, 121.1, 119.3],
                "256K": [139.0, 138.7, 138.3],
                "512K": [184.4, 179.3, 178.7],
                "1M": [303.9, 302.6, 301.6],
                "2M": [513.4, 511.6, 511.5],
                "4M": [999.8, 999.6, 997.6],
                "8M": [1980.4, 1979.3, 1978.5],
                "16M": [3951.9, 3948.7, 3945.7],
                "32M": [7896.9, 7894.5, 7892.6]
            },
            "OCCL Latency": {
                "512": [102.8, 104.1, 105.1],
                "1K": [101.1, 101.4, 101.7],
                "2K": [101.7, 102.1, 102.8],
                "4K": [101.7, 102.8, 103.6],
                "8K": [102.1, 102.4, 102.5],
                "16K": [105.3, 105.3, 106.5],
                "32K": [110.6, 115.0, 118.0],
                "64K": [116.1, 118.8, 124.6],
                "128K": [117.4, 119.7, 121.3],
                "256K": [132.0, 132.8, 132.8],
                "512K": [177.2, 179.2, 179.3],
                "1M": [297.1, 297.2, 302.2],
                "2M": [523.2, 524.2, 525.1],
                "4M": [1000.4, 1002.2, 1003.1],
                "8M": [1980.3, 1980.4, 1982.9],
                "16M": [3946.0, 3949.9, 3952.0],
                "32M": [7874.0, 7878.3, 7883.0]
            }
        },
        "RS": {
            "NCCL Bandwidth": {
                "512": [0.01, 0.01, 0.01],
                "1K": [0.01, 0.01, 0.01],
                "2K": [0.02, 0.02, 0.02],
                "4K": [0.04, 0.04, 0.04],
                "8K": [0.08, 0.08, 0.08],
                "16K": [0.15, 0.15, 0.15],
                "32K": [0.28, 0.28, 0.29],
                "64K": [0.54, 0.55, 0.57],
                "128K": [0.99, 1.01, 1.01],
                "256K": [1.83, 1.83, 1.87],
                "512K": [2.89, 2.9, 2.92],
                "1M": [3.35, 3.37, 3.38],
                "2M": [4.13, 4.13, 4.15],
                "4M": [4.21, 4.21, 4.22],
                "8M": [4.24, 4.24, 4.25],
                "16M": [4.25, 4.25, 4.25],
                "32M": [4.25, 4.25, 4.25]
            },
            "OCCL Bandwidth": {
                "512": [0.01, 0.01, 0.01],
                "1K": [0.01, 0.01, 0.01],
                "2K": [0.02, 0.02, 0.02],
                "4K": [0.04, 0.04, 0.04],
                "8K": [0.08, 0.08, 0.08],
                "16K": [0.17, 0.16, 0.16],
                "32K": [0.29, 0.29, 0.28],
                "64K": [0.6, 0.59, 0.54],
                "128K": [1.05, 0.93, 0.93],
                "256K": [1.92, 1.9, 1.88],
                "512K": [2.87, 2.86, 2.81],
                "1M": [3.45, 3.4, 3.37],
                "2M": [4.07, 4.06, 4.03],
                "4M": [4.21, 4.19, 4.19],
                "8M": [4.24, 4.23, 4.23],
                "16M": [4.25, 4.25, 4.25],
                "32M": [4.27, 4.26, 4.26]
            },
            "NCCL Latency": {
                "512": [101.1, 99.7, 98.86],
                "1K": [102.8, 101.1, 100.1],
                "2K": [102.2, 101.4, 97.67],
                "4K": [103.7, 100.9, 98.68],
                "8K": [104.3, 104.1, 102.2],
                "16K": [106.7, 106.2, 105.7],
                "32K": [116.6, 116.4, 113.5],
                "64K": [120.3, 118.2, 114.7],
                "128K": [132.2, 129.7, 129.6],
                "256K": [143.1, 143.1, 140.3],
                "512K": [181.3, 181.1, 179.7],
                "1M": [312.6, 310.9, 310.6],
                "2M": [507.7, 507.2, 505.8],
                "4M": [996.8, 995.3, 994.7],
                "8M": [1978.3, 1978.0, 1976.1],
                "16M": [3947.9, 3946.9, 3943.9],
                "32M": [7892.5, 7892.3, 7891.7]
            },
            "OCCL Latency": {
                "512": [98.01, 98.15, 100.9],
                "1K": [97.31, 98.03, 98.39],
                "2K": [96.43, 97.3, 97.74],
                "4K": [98.59, 100.4, 101.1],
                "8K": [97.76, 98.16, 99.2],
                "16K": [98.78, 101.6, 102.2],
                "32K": [111.7, 114.8, 118.1],
                "64K": [109.5, 111.1, 122.2],
                "128K": [124.5, 140.4, 141.4],
                "256K": [136.4, 138.1, 139.1],
                "512K": [182.7, 183.2, 186.3],
                "1M": [304.2, 308.8, 311.5],
                "2M": [515.8, 516.7, 519.9],
                "4M": [995.7, 1000.2, 1000.6],
                "8M": [1979.9, 1981.0, 1984.2],
                "16M": [3945.0, 3945.5, 3946.2],
                "32M": [7865.3, 7873.6, 7882.9]
            }
        },
        "B": {
            "NCCL Bandwidth": {
                "512": [0.02, 0.02, 0.02],
                "1K": [0.05, 0.05, 0.05],
                "2K": [0.09, 0.09, 0.1],
                "4K": [0.18, 0.18, 0.21],
                "8K": [0.32, 0.33, 0.37],
                "16K": [0.57, 0.59, 0.63],
                "32K": [1.0, 1.09, 1.15],
                "64K": [1.83, 1.89, 1.9],
                "128K": [2.33, 2.43, 2.43],
                "256K": [2.72, 2.73, 2.74],
                "512K": [2.81, 2.82, 2.83],
                "1M": [2.87, 2.88, 2.89],
                "2M": [3.49, 3.5, 3.5],
                "4M": [3.94, 3.95, 3.96],
                "8M": [4.26, 4.27, 4.27],
                "16M": [4.43, 4.44, 4.44],
                "32M": [4.51, 4.52, 4.52]
            },
            "OCCL Bandwidth": {
                "512": [0.02, 0.02, 0.02],
                "1K": [0.04, 0.04, 0.04],
                "2K": [0.07, 0.07, 0.07],
                "4K": [0.16, 0.15, 0.14],
                "8K": [0.3, 0.29, 0.28],
                "16K": [0.5, 0.5, 0.49],
                "32K": [0.92, 0.88, 0.86],
                "64K": [1.6, 1.54, 1.49],
                "128K": [2.17, 2.15, 2.12],
                "256K": [2.72, 2.68, 2.65],
                "512K": [2.91, 2.89, 2.87],
                "1M": [2.93, 2.92, 2.92],
                "2M": [3.48, 3.47, 3.47],
                "4M": [3.95, 3.95, 3.94],
                "8M": [4.23, 4.23, 4.23],
                "16M": [4.41, 4.41, 4.41],
                "32M": [4.49, 4.49, 4.49]
            },
            "NCCL Latency": {
                "512": [23.58, 22.43, 21.89],
                "1K": [22.64, 21.62, 20.92],
                "2K": [22.53, 22.07, 21.26],
                "4K": [23.36, 23.35, 19.95],
                "8K": [25.94, 24.93, 22.03],
                "16K": [28.51, 27.88, 26.13],
                "32K": [32.65, 30.1, 28.44],
                "64K": [35.77, 34.75, 34.44],
                "128K": [56.35, 54.01, 53.89],
                "256K": [96.31, 96.18, 95.74],
                "512K": [186.8, 185.9, 185.5],
                "1M": [365.9, 364.6, 363.1],
                "2M": [600.3, 599.3, 598.8],
                "4M": [1065.9, 1061.3, 1058.4],
                "8M": [1967.4, 1964.5, 1963.6],
                "16M": [3783.7, 3782.0, 3779.4],
                "32M": [7433.9, 7431.7, 7424.8]
            },
            "OCCL Latency": {
                "512": [27.63, 28.18, 28.71],
                "1K": [27.91, 28.05, 28.49],
                "2K": [29.32, 29.76, 29.79],
                "4K": [26.34, 28.2, 29.52],
                "8K": [27.33, 28.52, 29.18],
                "16K": [32.57, 33.07, 33.54],
                "32K": [35.79, 37.25, 38.29],
                "64K": [41.05, 42.56, 44.08],
                "128K": [60.36, 60.98, 61.7],
                "256K": [96.24, 98.0, 98.86],
                "512K": [180.0, 181.5, 182.5],
                "1M": [358.2, 359.0, 359.0],
                "2M": [602.9, 603.7, 604.2],
                "4M": [1061.1, 1062.3, 1063.6],
                "8M": [1980.9, 1981.8, 1983.2],
                "16M": [3800.1, 3800.1, 3801.7],
                "32M": [7467.7, 7472.1, 7474.9]
            }
        },
        "R": {
            "NCCL Bandwidth": {
                "512": [0.02, 0.03, 0.03],
                "1K": [0.04, 0.04, 0.04],
                "2K": [0.08, 0.08, 0.08],
                "4K": [0.14, 0.15, 0.17],
                "8K": [0.3, 0.31, 0.32],
                "16K": [0.52, 0.52, 0.56],
                "32K": [1.0, 1.01, 1.04],
                "64K": [1.64, 1.68, 1.7],
                "128K": [1.94, 2.19, 2.22],
                "256K": [2.32, 2.49, 2.56],
                "512K": [2.64, 2.67, 2.67],
                "1M": [2.7, 2.7, 2.7],
                "2M": [3.36, 3.36, 3.37],
                "4M": [3.79, 3.8, 3.8],
                "8M": [4.01, 4.01, 4.01],
                "16M": [4.02, 4.02, 4.02],
                "32M": [4.03, 4.03, 4.03]
            },
            "OCCL Bandwidth": {
                "512": [0.02, 0.02, 0.02],
                "1K": [0.04, 0.04, 0.04],
                "2K": [0.07, 0.07, 0.07],
                "4K": [0.14, 0.13, 0.12],
                "8K": [0.29, 0.25, 0.25],
                "16K": [0.46, 0.46, 0.46],
                "32K": [0.91, 0.83, 0.82],
                "64K": [1.41, 1.41, 1.4],
                "128K": [1.99, 1.96, 1.96],
                "256K": [2.52, 2.51, 2.46],
                "512K": [2.81, 2.79, 2.72],
                "1M": [2.8, 2.79, 2.79],
                "2M": [3.42, 3.42, 3.41],
                "4M": [3.83, 3.81, 3.81],
                "8M": [4.03, 4.02, 4.02],
                "16M": [4.03, 4.03, 4.03],
                "32M": [4.03, 4.02, 4.02]
            },
            "NCCL Latency": {
                "512": [23.58, 19.94, 19.88],
                "1K": [25.58, 25.33, 23.35],
                "2K": [26.96, 26.14, 25.35],
                "4K": [28.47, 27.64, 24.6],
                "8K": [27.19, 26.84, 25.45],
                "16K": [31.75, 31.25, 29.26],
                "32K": [32.82, 32.38, 31.58],
                "64K": [40.03, 39.1, 38.54],
                "128K": [67.6, 59.93, 58.93],
                "256K": [113.0, 105.4, 102.3],
                "512K": [198.6, 196.7, 196.5],
                "1M": [388.3, 388.2, 388.1],
                "2M": [624.3, 623.9, 622.1],
                "4M": [1106.8, 1104.8, 1103.6],
                "8M": [2092.8, 2092.4, 2090.8],
                "16M": [4171.6, 4171.0, 4169.7],
                "32M": [8319.0, 8318.8, 8317.5]
            },
            "OCCL Latency": {
                "512": [23.83, 26.78, 28.93],
                "1K": [23.91, 25.35, 28.41],
                "2K": [28.77, 30.06, 30.94],
                "4K": [28.32, 32.27, 33.03],
                "8K": [28.45, 32.86, 32.87],
                "16K": [35.39, 35.6, 35.94],
                "32K": [36.09, 39.62, 39.91],
                "64K": [46.33, 46.47, 46.77],
                "128K": [65.92, 66.85, 66.91],
                "256K": [104.1, 104.5, 106.8],
                "512K": [186.4, 187.7, 192.4],
                "1M": [374.8, 375.7, 376.0],
                "2M": [612.9, 613.7, 614.8],
                "4M": [1093.8, 1099.8, 1099.9],
                "8M": [2083.7, 2084.1, 2085.8],
                "16M": [4159.8, 4161.1, 4161.9],
                "32M": [8332.7, 8337.7, 8342.7]
            }
        }
    },
    "4hosts": {
        "AR": {
            "NCCL Bandwidth": {
                "512": [0.0, 0.0, 0.0],
                "1K": [0.0, 0.0, 0.0],
                "2K": [0.01, 0.01, 0.01],
                "4K": [0.01, 0.01, 0.01],
                "8K": [0.02, 0.02, 0.02],
                "16K": [0.05, 0.05, 0.05],
                "32K": [0.08, 0.09, 0.09],
                "64K": [0.16, 0.16, 0.16],
                "128K": [0.32, 0.33, 0.33],
                "256K": [0.59, 0.59, 0.59],
                "512K": [1.07, 1.08, 1.08],
                "1M": [1.5, 1.51, 1.53],
                "2M": [1.68, 1.69, 1.7],
                "4M": [2.04, 2.05, 2.05],
                "8M": [2.07, 2.07, 2.07],
                "16M": [2.08, 2.08, 2.08],
                "32M": [2.08, 2.08, 2.08]
            },
            "OCCL Bandwidth": {
                "512": [0.0, 0.0, 0.0],
                "1K": [0.0, 0.0, 0.0],
                "2K": [0.01, 0.01, 0.01],
                "4K": [0.01, 0.01, 0.01],
                "8K": [0.03, 0.03, 0.03],
                "16K": [0.05, 0.05, 0.05],
                "32K": [0.1, 0.1, 0.09],
                "64K": [0.17, 0.17, 0.16],
                "128K": [0.33, 0.32, 0.32],
                "256K": [0.57, 0.57, 0.56],
                "512K": [1.05, 1.01, 1.0],
                "1M": [1.49, 1.48, 1.46],
                "2M": [1.71, 1.71, 1.7],
                "4M": [2.01, 2.0, 2.0],
                "8M": [2.07, 2.06, 2.06],
                "16M": [2.08, 2.08, 2.08],
                "32M": [2.08, 2.08, 2.08]
            },
            "NCCL Latency": {
                "512": [296.5, 292.0, 286.9],
                "1K": [315.1, 292.3, 283.9],
                "2K": [317.5, 307.6, 301.9],
                "4K": [310.0, 309.6, 304.9],
                "8K": [341.6, 336.3, 330.1],
                "16K": [334.5, 324.4, 319.1],
                "32K": [393.5, 364.4, 361.8],
                "64K": [421.3, 414.4, 402.5],
                "128K": [415.5, 397.1, 394.8],
                "256K": [445.8, 444.4, 442.1],
                "512K": [491.6, 486.7, 485.8],
                "1M": [698.3, 696.5, 687.2],
                "2M": [1250.6, 1239.6, 1237.1],
                "4M": [2061.0, 2047.9, 2047.2],
                "8M": [4056.9, 4055.1, 4054.9],
                "16M": [8069.7, 8069.3, 8068.9],
                "32M": [16120.0, 16116.0, 16115.0]
            },
            "OCCL Latency": {
                "512": [290.4, 291.5, 293.4],
                "1K": [291.5, 292.8, 293.7],
                "2K": [303.7, 309.9, 310.2],
                "4K": [312.7, 319.1, 322.4],
                "8K": [315.2, 315.9, 323.0],
                "16K": [325.5, 327.3, 327.7],
                "32K": [338.5, 340.9, 382.5],
                "64K": [387.8, 391.7, 405.6],
                "128K": [394.0, 403.5, 413.9],
                "256K": [458.4, 459.4, 465.0],
                "512K": [499.1, 520.7, 521.7],
                "1M": [702.4, 707.6, 717.7],
                "2M": [1225.6, 1227.2, 1235.6],
                "4M": [2090.9, 2096.6, 2098.5],
                "8M": [4060.8, 4062.8, 4062.8],
                "16M": [8074.0, 8075.7, 8079.6],
                "32M": [16128.0, 16135.0, 16137.0]
            }
        },
        "AG": {
            "NCCL Bandwidth": {
                "512": [0.0, 0.0, 0.0],
                "1K": [0.0, 0.0, 0.01],
                "2K": [0.01, 0.01, 0.01],
                "4K": [0.02, 0.02, 0.02],
                "8K": [0.04, 0.04, 0.04],
                "16K": [0.07, 0.08, 0.08],
                "32K": [0.15, 0.15, 0.16],
                "64K": [0.27, 0.29, 0.3],
                "128K": [0.55, 0.58, 0.58],
                "256K": [1.08, 1.13, 1.16],
                "512K": [1.95, 2.0, 2.01],
                "1M": [2.94, 2.96, 2.96],
                "2M": [3.33, 3.35, 3.36],
                "4M": [3.98, 4.03, 4.05],
                "8M": [4.11, 4.11, 4.11],
                "16M": [4.14, 4.14, 4.14],
                "32M": [4.15, 4.15, 4.15]
            },
            "OCCL Bandwidth": {
                "512": [0.0, 0.0, 0.0],
                "1K": [0.01, 0.01, 0.01],
                "2K": [0.01, 0.01, 0.01],
                "4K": [0.02, 0.02, 0.02],
                "8K": [0.04, 0.04, 0.04],
                "16K": [0.08, 0.08, 0.08],
                "32K": [0.16, 0.15, 0.15],
                "64K": [0.31, 0.3, 0.29],
                "128K": [0.62, 0.62, 0.61],
                "256K": [1.17, 1.16, 1.16],
                "512K": [2.09, 2.07, 1.98],
                "1M": [3.01, 2.98, 2.97],
                "2M": [3.48, 3.47, 3.45],
                "4M": [3.93, 3.92, 3.9],
                "8M": [4.1, 4.1, 4.1],
                "16M": [4.14, 4.14, 4.14],
                "32M": [4.15, 4.15, 4.15]
            },
            "NCCL Latency": {
                "512": [199.8, 198.9, 194.7],
                "1K": [212.1, 205.8, 199.8],
                "2K": [214.7, 208.3, 204.2],
                "4K": [211.7, 205.8, 198.2],
                "8K": [203.3, 201.6, 195.5],
                "16K": [221.2, 215.6, 207.5],
                "32K": [222.8, 218.3, 202.7],
                "64K": [243.7, 222.6, 219.1],
                "128K": [237.2, 226.0, 225.8],
                "256K": [243.6, 231.2, 226.8],
                "512K": [268.3, 262.7, 260.3],
                "1M": [356.2, 354.7, 354.3],
                "2M": [629.8, 626.0, 625.0],
                "4M": [1052.7, 1040.3, 1036.9],
                "8M": [2042.0, 2041.4, 2041.3],
                "16M": [4053.0, 4052.4, 4050.8],
                "32M": [8095.0, 8091.6, 8091.0]
            },
            "OCCL Latency": {
                "512": [191.7, 194.8, 200.4],
                "1K": [193.0, 193.5, 194.2],
                "2K": [191.6, 193.4, 199.9],
                "4K": [192.5, 196.6, 197.1],
                "8K": [192.3, 195.4, 201.4],
                "16K": [195.2, 200.0, 200.1],
                "32K": [206.3, 211.5, 215.1],
                "64K": [213.7, 217.5, 227.3],
                "128K": [210.6, 212.9, 215.0],
                "256K": [224.8, 226.2, 226.3],
                "512K": [250.8, 253.8, 264.7],
                "1M": [348.2, 351.4, 353.1],
                "2M": [603.0, 603.6, 608.3],
                "4M": [1068.3, 1069.5, 1074.1],
                "8M": [2044.4, 2044.7, 2045.5],
                "16M": [4050.2, 4053.2, 4053.3],
                "32M": [8083.3, 8092.7, 8094.2]
            }
        },
        "RS": {
            "NCCL Bandwidth": {
                "512": [0.0, 0.0, 0.0],
                "1K": [0.0, 0.01, 0.01],
                "2K": [0.01, 0.01, 0.01],
                "4K": [0.02, 0.02, 0.02],
                "8K": [0.04, 0.04, 0.04],
                "16K": [0.07, 0.08, 0.08],
                "32K": [0.14, 0.14, 0.15],
                "64K": [0.28, 0.28, 0.29],
                "128K": [0.55, 0.57, 0.58],
                "256K": [1.07, 1.08, 1.08],
                "512K": [1.76, 1.79, 1.79],
                "1M": [2.79, 2.8, 2.82],
                "2M": [3.24, 3.27, 3.31],
                "4M": [4.07, 4.07, 4.07],
                "8M": [4.08, 4.1, 4.11],
                "16M": [4.14, 4.14, 4.14],
                "32M": [4.15, 4.15, 4.15]
            },
            "OCCL Bandwidth": {
                "512": [0.0, 0.0, 0.0],
                "1K": [0.01, 0.01, 0.01],
                "2K": [0.01, 0.01, 0.01],
                "4K": [0.02, 0.02, 0.02],
                "8K": [0.04, 0.04, 0.04],
                "16K": [0.09, 0.09, 0.08],
                "32K": [0.17, 0.17, 0.16],
                "64K": [0.31, 0.3, 0.29],
                "128K": [0.64, 0.64, 0.64],
                "256K": [1.12, 1.12, 1.11],
                "512K": [2.01, 1.99, 1.96],
                "1M": [2.87, 2.86, 2.83],
                "2M": [3.3, 3.27, 3.27],
                "4M": [3.98, 3.98, 3.93],
                "8M": [4.1, 4.08, 4.08],
                "16M": [4.13, 4.13, 4.13],
                "32M": [4.15, 4.15, 4.14]
            },
            "NCCL Latency": {
                "512": [210.3, 197.2, 195.8],
                "1K": [225.3, 201.5, 196.5],
                "2K": [202.3, 201.0, 196.0],
                "4K": [197.1, 194.1, 185.5],
                "8K": [198.4, 196.1, 195.4],
                "16K": [222.1, 214.2, 208.2],
                "32K": [233.5, 228.7, 211.7],
                "64K": [237.3, 236.3, 229.5],
                "128K": [239.7, 230.5, 226.0],
                "256K": [245.5, 242.1, 241.9],
                "512K": [298.4, 293.6, 293.1],
                "1M": [376.0, 374.7, 371.6],
                "2M": [648.1, 641.0, 633.4],
                "4M": [1031.8, 1030.0, 1029.6],
                "8M": [2057.7, 2047.7, 2043.1],
                "16M": [4053.7, 4053.2, 4053.1],
                "32M": [8092.0, 8091.4, 8089.9]
            },
            "OCCL Latency": {
                "512": [187.1, 187.2, 189.6],
                "1K": [185.5, 186.2, 191.3],
                "2K": [183.4, 184.3, 184.5],
                "4K": [184.2, 184.4, 186.6],
                "8K": [184.7, 185.0, 186.2],
                "16K": [186.8, 187.9, 198.4],
                "32K": [194.3, 194.9, 198.7],
                "64K": [208.7, 219.9, 224.8],
                "128K": [203.8, 204.4, 204.9],
                "256K": [234.6, 234.8, 235.5],
                "512K": [260.7, 263.1, 267.2],
                "1M": [365.8, 366.1, 370.6],
                "2M": [635.0, 640.7, 641.1],
                "4M": [1053.4, 1054.4, 1067.8],
                "8M": [2044.7, 2055.9, 2057.2],
                "16M": [4062.7, 4063.9, 4064.3],
                "32M": [8089.3, 8092.2, 8095.6]
            }
        },
        "B": {
            "NCCL Bandwidth": {
                "512": [0.01, 0.01, 0.02],
                "1K": [0.03, 0.03, 0.04],
                "2K": [0.05, 0.06, 0.06],
                "4K": [0.12, 0.13, 0.14],
                "8K": [0.25, 0.25, 0.25],
                "16K": [0.39, 0.44, 0.45],
                "32K": [0.73, 0.74, 0.78],
                "64K": [1.2, 1.22, 1.23],
                "128K": [1.58, 1.63, 1.67],
                "256K": [1.85, 1.86, 1.87],
                "512K": [1.88, 1.89, 1.99],
                "1M": [2.01, 2.01, 2.01],
                "2M": [2.65, 2.66, 2.67],
                "4M": [3.26, 3.29, 3.3],
                "8M": [3.66, 3.67, 3.68],
                "16M": [3.92, 3.92, 3.93],
                "32M": [4.06, 4.06, 4.06]
            },
            "OCCL Bandwidth": {
                "512": [0.01, 0.01, 0.01],
                "1K": [0.03, 0.02, 0.02],
                "2K": [0.05, 0.05, 0.05],
                "4K": [0.1, 0.1, 0.1],
                "8K": [0.19, 0.19, 0.19],
                "16K": [0.35, 0.31, 0.3],
                "32K": [0.64, 0.63, 0.59],
                "64K": [1.09, 1.05, 1.0],
                "128K": [1.5, 1.46, 1.41],
                "256K": [1.96, 1.88, 1.82],
                "512K": [2.16, 2.14, 1.97],
                "1M": [2.09, 2.09, 2.08],
                "2M": [2.7, 2.68, 2.67],
                "4M": [3.33, 3.31, 3.3],
                "8M": [3.66, 3.65, 3.62],
                "16M": [3.9, 3.89, 3.89],
                "32M": [4.05, 4.05, 4.05]
            },
            "NCCL Latency": {
                "512": [37.26, 35.56, 33.79],
                "1K": [40.05, 35.55, 29.23],
                "2K": [40.11, 35.89, 33.66],
                "4K": [35.02, 30.46, 29.88],
                "8K": [33.07, 32.77, 32.44],
                "16K": [41.65, 37.03, 36.7],
                "32K": [44.96, 44.31, 42.2],
                "64K": [54.5, 53.92, 53.25],
                "128K": [82.99, 80.62, 78.53],
                "256K": [141.5, 140.9, 140.4],
                "512K": [278.2, 276.9, 263.6],
                "1M": [523.0, 522.5, 521.8],
                "2M": [790.5, 789.5, 784.4],
                "4M": [1285.3, 1273.4, 1272.0],
                "8M": [2289.9, 2285.8, 2278.9],
                "16M": [4281.1, 4278.0, 4269.4],
                "32M": [8262.7, 8261.1, 8261.0]
            },
            "OCCL Latency": {
                "512": [35.03, 36.58, 37.1],
                "1K": [37.48, 41.81, 42.96],
                "2K": [40.44, 41.38, 43.14],
                "4K": [40.01, 40.43, 40.45],
                "8K": [42.29, 43.91, 44.1],
                "16K": [46.34, 53.0, 54.8],
                "32K": [51.2, 51.92, 55.18],
                "64K": [60.1, 62.17, 65.35],
                "128K": [87.56, 89.89, 92.8],
                "256K": [133.7, 139.7, 143.8],
                "512K": [242.7, 245.4, 266.3],
                "1M": [501.7, 502.1, 503.7],
                "2M": [776.2, 783.3, 784.9],
                "4M": [1258.0, 1266.7, 1269.1],
                "8M": [2294.3, 2296.2, 2319.3],
                "16M": [4297.0, 4315.9, 4316.7],
                "32M": [8287.3, 8288.2, 8289.4]
            }
        },
        "R": {
            "NCCL Bandwidth": {
                "512": [0.02, 0.02, 0.02],
                "1K": [0.03, 0.03, 0.03],
                "2K": [0.06, 0.06, 0.06],
                "4K": [0.11, 0.11, 0.11],
                "8K": [0.21, 0.22, 0.22],
                "16K": [0.39, 0.4, 0.4],
                "32K": [0.69, 0.7, 0.7],
                "64K": [1.15, 1.16, 1.17],
                "128K": [1.47, 1.49, 1.52],
                "256K": [1.68, 1.69, 1.69],
                "512K": [1.75, 1.75, 1.76],
                "1M": [1.78, 1.79, 1.79],
                "2M": [2.45, 2.46, 2.46],
                "4M": [3.07, 3.07, 3.07],
                "8M": [3.51, 3.51, 3.52],
                "16M": [3.75, 3.75, 3.76],
                "32M": [3.88, 3.88, 3.88]
            },
            "OCCL Bandwidth": {
                "512": [0.01, 0.01, 0.01],
                "1K": [0.03, 0.03, 0.02],
                "2K": [0.05, 0.05, 0.05],
                "4K": [0.09, 0.09, 0.08],
                "8K": [0.18, 0.18, 0.17],
                "16K": [0.33, 0.33, 0.31],
                "32K": [0.58, 0.58, 0.58],
                "64K": [1.0, 0.96, 0.95],
                "128K": [1.4, 1.34, 1.32],
                "256K": [1.71, 1.69, 1.67],
                "512K": [1.8, 1.79, 1.79],
                "1M": [1.83, 1.83, 1.82],
                "2M": [2.52, 2.51, 2.5],
                "4M": [3.1, 3.1, 3.1],
                "8M": [3.53, 3.53, 3.52],
                "16M": [3.75, 3.75, 3.75],
                "32M": [3.89, 3.88, 3.88]
            },
            "NCCL Latency": {
                "512": [31.3, 31.22, 30.99],
                "1K": [31.57, 31.54, 30.49],
                "2K": [33.44, 33.34, 32.79],
                "4K": [38.08, 38.04, 36.58],
                "8K": [38.26, 38.08, 37.91],
                "16K": [42.24, 41.06, 40.83],
                "32K": [47.43, 46.55, 46.53],
                "64K": [57.09, 56.32, 55.9],
                "128K": [88.89, 88.11, 86.47],
                "256K": [155.6, 155.0, 154.8],
                "512K": [299.7, 299.2, 298.7],
                "1M": [588.6, 586.5, 585.6],
                "2M": [857.1, 853.8, 851.5],
                "4M": [1366.9, 1364.9, 1364.6],
                "8M": [2392.5, 2391.0, 2382.9],
                "16M": [4473.7, 4471.3, 4467.1],
                "32M": [8654.6, 8653.5, 8652.1]
            },
            "OCCL Latency": {
                "512": [38.41, 39.58, 42.06],
                "1K": [38.82, 40.47, 42.16],
                "2K": [43.31, 43.83, 44.54],
                "4K": [44.84, 46.13, 48.25],
                "8K": [45.38, 45.47, 46.93],
                "16K": [49.03, 49.79, 52.46],
                "32K": [56.07, 56.53, 56.63],
                "64K": [65.71, 68.57, 68.71],
                "128K": [93.4, 97.85, 99.46],
                "256K": [152.9, 154.8, 156.7],
                "512K": [291.1, 292.1, 292.4],
                "1M": [572.1, 574.0, 577.0],
                "2M": [833.2, 835.6, 840.2],
                "4M": [1351.2, 1352.3, 1352.8],
                "8M": [2376.0, 2377.9, 2381.8],
                "16M": [4468.5, 4469.6, 4473.3],
                "32M": [8631.8, 8640.1, 8652.6]
            }
        }
    }
}


# nccl 用黄色，occl 用蓝色
color_dict = {
    legends[0]: (250/255, 134/255, 0/255),
    legends[1]: (33/255, 158/255, 188/255),
    legends[2]: (250/255, 134/255, 0/255),
    legends[3]: (33/255, 158/255, 188/255),
}

# bw用bar，lat用line
hatch_dict = {
    legends[0]: "/",
    legends[1]: "\\"
}

def plot_line_bar(data_dict, figname, figsize, bar_width, the_data_set, the_func, legends_loc="best", y_nbins=None, hline=False):
    plt.close("all")
    if (the_func == "R"):
        plt.figure(1, figsize=(11, 3.4))
    else:
        plt.figure(1, figsize=figsize) # (11, 4.1)

    slice_start = 2
    slice_num = 17

    plot_bar_data_dict = {}
    plot_line_data_dict = {}
    for i, legend in enumerate(legends):
        if i < 2: # bar
            l = [np.mean(data_list)
                        for data_list in data_dict[legend].values()]
            plot_bar_data_dict.setdefault(legend, dict()).setdefault(
                "avg",
                np.array(l[slice_start:slice_num])
            )
            l = [np.std(data_list)
                        for data_list in data_dict[legend].values()]
            plot_bar_data_dict.setdefault(legend, dict()).setdefault(
                "stderr",
                np.array(l[slice_start:slice_num])
            )
            # print(legend, plot_bar_data_dict[legend])
        else:
            l = [np.mean(data_list)
                        for data_list in data_dict[legend].values()]
            # print(legend, "avg", l)
            plot_line_data_dict.setdefault(legend, dict()).setdefault(
                "avg",
                np.array(l[slice_start:slice_num])
            )
            l = [np.std(data_list)
                        for data_list in data_dict[legend].values()]
            # print(legend, "stderr", l)
            plot_line_data_dict.setdefault(legend, dict()).setdefault(
                "stderr",
                np.array(l[slice_start:slice_num])
            )

    # 提前设置：
    x_labels_slice = x_labels[slice_start:slice_num]
    x_pos = np.array([i for i in range(len(x_labels_slice))])
    if (the_func == "R"):
        plt.xlabel("Buffer Size (B)", size='24')
    plt.xticks(x_pos, x_labels_slice) #, rotation=5
    plt.tick_params(axis='x', labelsize='16')
    y_labelsize = '20'

    # 先画bar
    error_attri = dict(capsize=2)
    bars = []
    num_bar = len(plot_bar_data_dict)

    for i, legend in enumerate(legends):
        if i < 2:
            bars.append(
                plt.bar(plot_bar.calc_bar_pos(num_bar, x_pos, i, bar_width), plot_bar_data_dict[legend]["avg"], bar_width, yerr=plot_bar_data_dict[legend]["stderr"],     error_kw=error_attri, fill=False, hatch=hatch_dict[legend], edgecolor=color_dict[legend], zorder=10)
            )
    if (the_data_set == "16_4card"):
        plt.ylabel("Bandwidth (GB/s)", size="21")
    plt.tick_params(axis='y', labelsize=y_labelsize)
    plt.yscale("log")

    plt.twinx()

    # 再画line
    lines = []
    for i, legend in enumerate(legends):
        if i >= 2:
            lines.append(
                plt.errorbar(x_pos, plot_line_data_dict[legend]["avg"], yerr=plot_line_data_dict[legend]["stderr"], capsize=2, color=color_dict[legend], zorder=100)
            )
    if (the_data_set == dataset[1]):
        plt.ylabel("Latency (us)", size="22")
    plt.tick_params(axis='y', labelsize=y_labelsize)
    plt.yscale("log")

    # 共用的操作、参数
    if (the_data_set == "4hosts" and the_func == "AR"):
        plt.legend(bars+lines, legends,
            loc=legends_loc, prop={'size': '16'})
    plt.tight_layout()
    plt.savefig(figname)
    # plt.show()
    

if __name__ == "__main__":
    
    # dataset = ["4hosts"]
    # func = ["AR"]

    for the_data_set in dataset:
        
        for the_func in func:
            figname = "MPI_"+the_data_set+"_"+the_func+".pdf"
            print(figname)
            plot_line_bar(data_dict[the_data_set][the_func], "figures_MPI/"+figname, (11, 3.3), 0.33, the_data_set, the_func)